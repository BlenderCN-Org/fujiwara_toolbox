# MarvelousDesigner関係機能

## 必要機能のインストール
1. [python3](https://www.python.org/downloads/)をインストールする。
1. fujiwara_toolbox\tools\install dependencies（管理者として実行）.batを管理者として実行する。

## 前提
* キャラにはジオメトリ用ボーンとして"Geometry","geometry","geo"のいずれかのボーンが必要
* キャラのポージングは、プロクシやリンクのトランスフォームは初期値にして、ジオメトリ用ボーンで全体の位置を変更する。
* 画像マッチングによってMarvelousDesignerを制御しているので、MarvelousDesignerのウィンドウ表示が拡大されていたりすると操作できない。（画面設定の倍率や、4Kモニタなどで起動したときに勝手に拡大表示になるのがマズい。）
* ウィルス対策ソフトでfujiwara_toolbox下を除外設定しておく（uwsc_wrapper.exeがよく疑われる）

## 機能
### オート
* オートインポートのみ  
    シミュレート結果を全て自動でインポートする。
* オートインポートしてアタッチ
    オートインポート後、漫画処理をアタッチする。
* オートインポートしてGLレンダ

### MDWorkファイル
* MD作業ファイル準備  
    中間ポーズを手動調整するための作業ファイルに移動する
* 元を開く、戻る、終了  
    作業ファイルからの移動。
* 選択物を全てシミュレート
    選択物をエクスポートし、MarvelousDesignerでシミュレショーンする。
    完了するとblendファイルが開き直される。
    作業ファイル上で実行した場合は開き直さない。
* エクスポートのみ
    選択物のエクスポートのみ行う。

### MD用オブジェクトセットアップ
* 衣装パスを追加  
    このオブジェクトが使用する衣装ファイルを指定する。
    未指定の場合、リンクオブジェクトであればリンク先のフォルダの、同名の.zpacを探す。  
    なお、設定は全てルート（＝一番親の）オブジェクトに保存されるので、どの子オブジェクトを選択していても問題ない。
* エクスポートIDを設定
    エクスポートIDが設定されてるオブジェクトがアバターとして出力される。
    未指定の場合、選択オブジェクトがそのままアバターとして出力される。
    キャラなどをリンクする場合は不要なオブジェクトが出力されて処理が重くなる原因になるので、必ず設定すること。

### MD用オブジェクト運用設定
* 衣装インデックスの設定  
    「衣装パスを追加」で設定したパスのうち、何番目のパスを使用するか。
    未指定の場合0番を使用する。
* エクスポート深度設定  
    指定したIDまでがエクスポートされる。
    2、とすれば、0、1、2番のIDが設定されてるアバターが出力される。
* エクスポートIDの追加
    0,2,4など、飛び飛びの番号を指定したいときに使う。

### 設定消去
* 選択物の設定を全て消去

## 準備
1. アバターとして使いたいオブジェクトに、「エクスポートIDを設定」をしておく。
1. 同じオブジェクトに、「衣装パスを追加」をして、使いたい衣装を指定しておく。  
リンクして使うキャラクターなどは、あらかじめ使用する衣装を一通り登録しておく。

## 運用時の設定
* リンクオブジェクトなどで「衣装インデックスの設定」をすることで、衣装を使い分けることができる。
* リンクオブジェクトなどで「エクスポート深度設定」をすることで、アバター出力を使い分けることができる。
* リンクオブジェクトに対しての設定はリンク先にある設定よりも優先される。

## シミュレーションの手順
1. MarvelousDesignerを起動しておく
1. シミュレーションをしたい.blendファイルを起動
1. シミュレーションをしたいオブジェクト「のみ」を選択
1. 「メイン」→「MarvelousDesigner」→「すべてシミュレート」
1. MarvelousDesignerが自動操作されるので、キーボード・マウスから手を離しておく。
1. 完了すると、.blendファイルが再起動する。
1. 「メイン」→「MarvelousDesigner」→「オートインポート」をすると、自動的にシミュレーション結果の.objが読み込まれる。


## ポイント
* 「MD用オブジェクトセットアップ」も「MD用オブジェクト運用設定」も、リンクオブジェクトに限らず、一つのオブジェクトに同時に設定することができる。  
ささっと済ませたいプロップなどは、わざわざリンク化せずにその場でシミュレーションを開始できる。

## simulation_config
* fujiwara_toolbox\tools\mdcontrol\simulation_config.pyでシミュレーションのオプションが設定できる。
* simulate_time  
    シミュレーション時間。単位は秒。
* use_thickness  
    エクスポート時に厚みをつけるかどうか。True/False
    MarvelousDesigner7は厚みをつけると不具合がでることがあるのでFalseにしたほうがよい。
    6.5ならTrueでも問題ない。

## 既知の不具合
* メインディスプレイより左側、上側の座標にMarvelousDesignerがある場合、正常に動きません。
